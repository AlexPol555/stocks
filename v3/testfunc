    SELECT 
        c.contract_code, 
        dd.date,
        dd.open,
        dd.low,
        dd.high,
        dd.close,
        dd.volume,
        
        -- Для "Открытых позиций"
        MAX(CASE WHEN m.metric_type = 'Открытые позиции' THEN m.value1 ELSE NULL END) AS long_fiz_1,
        MAX(CASE WHEN m.metric_type = 'Открытые позиции' THEN m.value2 ELSE NULL END) AS short_fiz_2,
        MAX(CASE WHEN m.metric_type = 'Открытые позиции' THEN m.value3 ELSE NULL END) AS long_jur_3,
        MAX(CASE WHEN m.metric_type = 'Открытые позиции' THEN m.value4 ELSE NULL END) AS short_jur_4,
        MAX(CASE WHEN m.metric_type = 'Открытые позиции' THEN m.value5 ELSE NULL END) AS total_positions,
        
        -- Для "Количество лиц"
        MAX(CASE WHEN m.metric_type = 'Количество лиц' THEN m.value1 ELSE NULL END) AS count_fiz_1,
        MAX(CASE WHEN m.metric_type = 'Количество лиц' THEN m.value2 ELSE NULL END) AS count_fiz_2,
        MAX(CASE WHEN m.metric_type = 'Количество лиц' THEN m.value3 ELSE NULL END) AS count_jur_3,
        MAX(CASE WHEN m.metric_type = 'Количество лиц' THEN m.value4 ELSE NULL END) AS count_jur_4,
        MAX(CASE WHEN m.metric_type = 'Количество лиц' THEN m.value5 ELSE NULL END) AS total_count
        
    FROM daily_data AS dd
    JOIN metrics AS m 
        ON dd.company_id = m.company_id 
    JOIN companies AS c 
        ON dd.company_id = c.id
    WHERE m.metric_type IN ('Открытые позиции', 'Количество лиц')
    GROUP BY dd.company_id, dd.date
    ORDER BY dd.date