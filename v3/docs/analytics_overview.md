# Математический и инвестиционно-экономический блок

## Конфигурация индикаторов
- Параметры SMA/EMA, RSI, MACD, Bollinger, стохастика и ATR берутся из `config/analytics.yml`.
- Профили подбираются по классу актива, таймфрейму и волатильности (`core.config.manager.AnalyticsConfig`).
- Волатильность оценивается по ATR%: бакеты `low/medium/high` переключают группы параметров и риск-профили.

## Подбор параметров
- Используйте `core.analytics.workflows.run_walk_forward_workflow` и `run_cross_validation_workflow` для пакетной оптимизации.
- Экономические ограничения (`OptimizationConstraint`) фильтруют нестабильные комбинации (минимум сделок, win-rate, profit factor, drawdown, CAGR).
- Готовые отчёты сохраняйте через `save_optimisation_report` — CSV кладутся в `reports/optimisation/` с подписью контракта и даты.
- Пример вызова:
  ```python
  from core.analytics import workflows
  from core.analytics.optimisation import build_parameter_grid

  grid = {"sma_fast": [13, 21, 34], "atr_period": [14, 18, 21]}
  wf_df = workflows.run_walk_forward_workflow(conn, "SBER", grid)
  workflows.save_optimisation_report(wf_df, report_name="sber_walk_forward")
  ```

## Динамический риск-менеджмент и P&L
- Метод `apply_risk_management` рассчитывает сделки отдельно для long/short с ATR-стопами, таргетами, трейлингами и лимитом дней удержания.
- Торговые издержки (`TradingCosts`) учитывают комиссии, налоги, проскальзывание, стоимость плеча и заём; параметры можно переопределить через переменные окружения `STOCKS_*`.
- В витрине `get_calculated_data` возвращаются нетто-прибыли (`Dynamic_Profit_*`) и метрики MFE/MAE для обеих сторон рынка.

## Метрики и KPI
- Функция `compute_kpi_for_signals` строит отчет по win-rate, среднему/медианному P&L, profit factor, CAGR, Sharpe/Sortino и максимальной просадке.
- На дашборде KPI отображаются в блоке "Signal filters" и карточках KPI; данные также доступны для экспорта.

## Дополнительные данные
- Сигнальная модель `compute_signal_scores` использует фильтры по тренду, momentum, волатильности, объёму и позициям участников (`long_fiz_1`, `short_fiz_2`, `long_jur_3`, `short_jur_4`, `total_positions`).
- Дополнительные фильтры (`calculate_additional_filters`) контролируют объём и умеренную волатильность, что повышает устойчивость сигналов.

## План расширения на фундаментальные и макро факторы
1. Подключить внешний ETL с макроиндикаторами (инфляция, ставки, PMI) и хранить их в отдельной таблице с ключом `date` + `region`.
2. Добавить сезонные признаки (месяц, квартал, холидаys) и скорректировать индикаторы через STL/HP-фильтры.
3. Включить корпоративные события (дивиденды, отчётности, SPO) — хранить календарь и добавлять dummy-признаки в скоринговую модель.
4. Расширить конфигурацию `analytics.yml` блоком `macro_features` для управления весами и источниками данных.
5. Обновить тестовый контур, добавив регрессионные тесты на влияние новых факторов и сравнение с базовой моделью.

## Документирование результатов
- Все запускы оптимизации фиксируйте в `reports/optimisation/` (имя файла = тикер + тип оптимизации + timestamp).
- Для каждой сессии сохраняйте JSON/CSV с параметрами и KPI, а краткий summary добавляйте в README проекта или Confluence.
- Рекомендуется в `tests/` держать минимальные проверки расчёта индикаторов и сигналов для ключевых контрактов, чтобы зафиксировать ожидаемые значения профилей.
