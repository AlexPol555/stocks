import pandas as pd
from lightweight_charts import Chart


def get_bar_data(symbol, timeframe):
    if symbol not in ('AAPL', 'GOOGL', 'TSLA'):
        print(f'No data for "{symbol}"')
        return pd.DataFrame()
    return pd.read_csv(f'bar_data/{symbol}_{timeframe}.csv')


def on_search(chart, searched_string):
    new_data = get_bar_data(searched_string, chart.topbar['timeframe'].value)
    if new_data.empty:
        return
    chart.topbar['symbol'].set(searched_string)
    chart.set(new_data)
    
    # Load the drawings saved under the symbol.
    chart.toolbox.load_drawings(searched_string)


def on_timeframe_selection(chart, timeframe):
    new_data = get_bar_data(chart.topbar['symbol'].value, timeframe)
    if new_data.empty:
        return
    chart.set(new_data)


def on_crosshair_move(chart, point):
    if point is None:
        return
    chart.topbar['price'].set(f'Price: ${point.price}')


def main():
    chart = Chart()
    
    # Add some controls to the topbar
    chart.topbar.textbox('symbol', 'AAPL')
    chart.topbar.switcher('timeframe', ('1min', '5min', '15min', '1hour', '4hour', '1day'), '1day')
    chart.topbar.textbox('price', 'Price: $0.00')
    
    # Set the callbacks
    chart.topbar['symbol'].on('change', lambda: on_search(chart, chart.topbar['symbol'].value))
    chart.topbar['timeframe'].on('change', lambda: on_timeframe_selection(chart, chart.topbar['timeframe'].value))
    chart.crosshair.on('move', lambda point: on_crosshair_move(chart, point))
    
    # Load the initial data
    on_search(chart, 'AAPL')
    
    chart.show(block=True)


if __name__ == '__main__':
    main()
